# Gymtec ERP - AI Coding Rules
# Para: Cursor AI, Claude, Gemini, Copilot
# √öltima actualizaci√≥n: Enero 2026

## üö® REGLAS CR√çTICAS (OBLIGATORIAS)

### 1. Idioma y Comunicaci√≥n
- Responder SIEMPRE en espa√±ol
- Todo texto visible en UI debe estar en espa√±ol
- Comentarios de c√≥digo pueden ser en ingl√©s o espa√±ol

### 2. Testing Obligatorio
- **EJECUTAR `npm test` despu√©s de CUALQUIER cambio en backend/**
- Si alg√∫n test falla, CORREGIR antes de continuar
- Los tests validan que los endpoints funcionan contra el VPS real

### 3. Verificar Schema Antes de Queries
- **LEER CLAUDE.md** antes de escribir queries SQL
- La BD del VPS tiene diferencias con el c√≥digo local
- Columnas que NO existen en VPS:
  - `spare_part_requests.spare_part_name` ‚Üí usar JOIN con Inventory
  - `spare_part_requests.quantity_needed` ‚Üí usar `quantity`
  - `spare_part_requests.purchase_order_id` ‚Üí NO existe
  - `Inventory.category_id` ‚Üí usar `category` (VARCHAR)

### 4. Flujo de Deploy
1. Modificar c√≥digo localmente
2. Ejecutar `npm test` (backend/)
3. Si pasan tests, subir con `scp` al VPS
4. Reiniciar con `pm2 restart gymtec-backend`
5. Verificar logs con `pm2 logs`

## üõ†Ô∏è Stack T√©cnico

| Componente | Tecnolog√≠a |
|------------|------------|
| Frontend | HTML + JavaScript Vanilla + TailwindCSS |
| Backend | Node.js + Express (server-clean.js) |
| Base de Datos | MySQL 8 |
| VPS | 91.107.237.159 |
| Testing | Jest + Supertest |

## üì¶ Est√°ndares de C√≥digo

### JavaScript
- Variables: `const` por defecto, `let` solo si muta
- NUNCA usar `var`
- SIEMPRE usar `async/await`, nunca callbacks
- SIEMPRE usar `try-catch` en operaciones async
- Arrow functions para callbacks: `() => {}`
- Template literals para strings: \`texto ${variable}\`

### SQL
- Nombres de tablas: `PascalCase` (Tickets, Equipment)
- Usar queries parametrizadas: `'SELECT * FROM x WHERE id = ?', [id]`
- NUNCA concatenar strings en queries SQL

### Frontend
- JavaScript Vanilla √∫nicamente
- NO sugerir React, Vue, Angular, etc.
- Usar `querySelector`, `addEventListener`
- Fetch con `authenticatedFetch()` de auth.js

## üîß Comandos √ötiles

```bash
# Tests (obligatorio despu√©s de cambios)
cd backend && npm test

# Logs del VPS
ssh root@91.107.237.159 "pm2 logs gymtec-backend --err --lines 30 --nostream"

# Reiniciar VPS
ssh root@91.107.237.159 "pm2 restart gymtec-backend"

# Subir archivo
scp archivo.js root@91.107.237.159:/var/www/gymtec/backend/src/
```

## üìÇ Archivos Importantes

| Archivo | Descripci√≥n |
|---------|-------------|
| `backend/src/server-clean.js` | Servidor principal (~9500 l√≠neas) |
| `backend/src/routes/inventory.js` | API de inventario |
| `backend/src/routes/purchase-orders.js` | API de √≥rdenes de compra |
| `backend/src/db-adapter.js` | Conexi√≥n MySQL |
| `backend/tests/*.test.js` | Tests automatizados |
| `CLAUDE.md` | Contexto completo del proyecto |

## ü§ñ Preferencias de Flujo

- **Autonom√≠a**: Ejecutar tareas proactivamente
- **Tests**: OBLIGATORIO ejecutar despu√©s de cambios
- **Verificaci√≥n**: Revisar logs del VPS despu√©s de deploy
- **GitHub**: NUNCA commit/push sin autorizaci√≥n expl√≠cita

## üìù Nomenclatura

- Variables/Funciones: `camelCase`
- Clases: `PascalCase`
- Constantes: `UPPER_SNAKE_CASE`
- Archivos: `kebab-case.js`
- Tablas SQL: `PascalCase`

## üîí ARQUITECTURA MODULAR (REGLAS ANTI-FALLO)

### Principio Fundamental
**Cambios en un m√≥dulo NO PUEDEN romper otro m√≥dulo.**

### Estructura de M√≥dulos
```
backend/src/modules/
‚îú‚îÄ‚îÄ tickets/           # Solo c√≥digo de tickets
‚îú‚îÄ‚îÄ planning/          # Solo c√≥digo del planificador
‚îú‚îÄ‚îÄ inventory/         # Solo c√≥digo de inventario
‚îú‚îÄ‚îÄ finance/           # Solo c√≥digo financiero
‚îî‚îÄ‚îÄ ...
```

### Regla 1: Sin Imports Cruzados
```javascript
// ‚ùå PROHIBIDO: Un m√≥dulo importa de otro
const { getTicket } = require('../tickets/tickets.service');

// ‚úÖ CORRECTO: Cada m√≥dulo hace sus propias queries
const ticket = await db.get('SELECT * FROM Tickets WHERE id = ?', [id]);
```

### Regla 2: Configuraci√≥n Centralizada
```javascript
// ‚ùå PROHIBIDO: Definir secretos localmente
const JWT_SECRET = process.env.JWT_SECRET || 'mi_secreto';

// ‚úÖ CORRECTO: Importar del core
const { JWT_SECRET } = require('../../core/config/env');
```

### Regla 3: Middleware Compartido desde Core
```javascript
// ‚ùå PROHIBIDO: Copiar authenticateToken en cada archivo
function authenticateToken(req, res, next) { ... }

// ‚úÖ CORRECTO: Importar del core
const { authenticateToken } = require('../../core/middleware/auth.middleware');
```

### Regla 4: Eventos para Comunicaci√≥n
```javascript
// ‚ùå PROHIBIDO: Llamar directamente a otro m√≥dulo
triggerNotificationProcessing('create', ticketId);

// ‚úÖ CORRECTO: Emitir evento
eventBus.emit('TICKET_CREATED', { ticketId });
```

### Regla 5: Try/Catch Obligatorio
```javascript
// ‚ùå PROHIBIDO: Endpoints sin manejo de errores
router.get('/', async (req, res) => {
  const data = await service.getAll(); // Si falla, tumba todo
  res.json(data);
});

// ‚úÖ CORRECTO: Errores contenidos
router.get('/', async (req, res, next) => {
  try {
    const data = await service.getAll();
    res.json({ message: 'success', data });
  } catch (error) {
    next(error); // Pasa al error handler global
  }
});
```

### Antes de Modificar Cualquier M√≥dulo
1. **Verificar que NO importas de otro m√≥dulo**
2. **Verificar que NO modificas archivos fuera de tu m√≥dulo**
3. **Ejecutar tests del m√≥dulo espec√≠fico**
4. **Ejecutar tests de integraci√≥n**

### Archivos que NUNCA Debes Modificar Sin Autorizaci√≥n
- `core/config/env.js` - Configuraci√≥n global
- `core/middleware/auth.middleware.js` - Autenticaci√≥n
- `server.js` - Entry point