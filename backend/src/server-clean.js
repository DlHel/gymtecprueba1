const express = require('express');
const cors = require('cors');
const path = require('path');
const multer = require('multer');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');

// Base de datos - usando adaptador configurable
const dbAdapter = require('./db-adapter');
const db = dbAdapter;

// Servicios de Autenticaci√≥n
const AuthService = require('./services/auth-service');

// Validadores
const { 
    validateClient, 
    validateClientUpdate, 
    validateLocation, 
    validateLocationUpdate, 
    validateEquipment, 
    validateEquipmentUpdate 
} = require('./validators');

// ===================================================================
// CONFIGURACI√ìN B√ÅSICA DE EXPRESS
// ===================================================================

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware b√°sico
app.use(cors());
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));

// Archivos est√°ticos
app.use(express.static(path.join(__dirname, '../../frontend')));
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// Configuraci√≥n de multer para subida de archivos
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, path.join(__dirname, '../uploads/models/'));
    },
    filename: function (req, file, cb) {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
});

const upload = multer({ 
    storage: storage,
    limits: { fileSize: 10 * 1024 * 1024 },
    fileFilter: (req, file, cb) => {
        const allowedTypes = /jpeg|jpg|png|gif/;
        const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
        const mimetype = allowedTypes.test(file.mimetype);
        
        if (mimetype && extname) {
            return cb(null, true);
        } else {
            cb(new Error('Solo se permiten im√°genes (JPEG, JPG, PNG, GIF)'));
        }
    }
});

const uploadManuals = multer({ 
    storage: multer.memoryStorage(),
    limits: { fileSize: 50 * 1024 * 1024 },
    fileFilter: (req, file, cb) => {
        const allowedTypes = /pdf|doc|docx/;
        const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
        const allowedMimes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        const mimetype = allowedMimes.includes(file.mimetype);
        
        if (mimetype && extname) {
            return cb(null, true);
        } else {
            cb(new Error('Solo se permiten documentos PDF, DOC y DOCX'));
        }
    }
});

// ===================================================================
// MIDDLEWARE DE AUTENTICACI√ìN Y AUTORIZACI√ìN
// ===================================================================

// Verificar token JWT
function authenticateToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];

    if (!token) {
        return res.status(401).json({
            error: 'Token de acceso requerido',
            code: 'MISSING_TOKEN'
        });
    }

    jwt.verify(token, AuthService.JWT_SECRET, (err, user) => {
        if (err) {
            console.log('‚ùå Token inv√°lido:', err.message);
            return res.status(403).json({
                error: 'Token inv√°lido o expirado',
                code: 'INVALID_TOKEN'
            });
        }
        req.user = user;
        next();
    });
}

// Middleware para verificar roles
function requireRole(roles) {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                error: 'Usuario no autenticado',
                code: 'NOT_AUTHENTICATED'
            });
        }

        const userRole = req.user.role;
        const hasPermission = roles.some(role => {
            if (role === 'Admin') {
                return userRole === 'Admin' || userRole === 'Administrador';
            }
            return userRole === role;
        });

        if (!hasPermission) {
            return res.status(403).json({
                error: 'Permisos insuficientes',
                code: 'INSUFFICIENT_PERMISSIONS',
                required: roles,
                current: userRole
            });
        }

        next();
    };
}

// ===================================================================
// RUTAS DE AUTENTICACI√ìN
// ===================================================================

app.post('/api/auth/login', async (req, res) => {
    const { username, password } = req.body;

    if (!username || !password) {
        return res.status(400).json({
            error: 'Username y contrase√±a son requeridos',
            code: 'MISSING_CREDENTIALS'
        });
    }

    try {
        const result = await AuthService.login(username, password);
        
        console.log(`‚úÖ Login exitoso para usuario: ${username}`);
        
        res.json({
            message: 'Login exitoso',
            ...result
        });

    } catch (error) {
        console.log(`‚ùå Login fallido para usuario: ${username} - ${error.message}`);
        
        res.status(401).json({
            error: error.message,
            code: error.code || 'LOGIN_FAILED'
        });
    }
});

app.post('/api/auth/logout', authenticateToken, (req, res) => {
    console.log(`üì§ Logout del usuario: ${req.user.username}`);
    
    res.json({
        message: 'Logout exitoso'
    });
});

app.get('/api/auth/verify', authenticateToken, (req, res) => {
    res.json({
        message: 'Token v√°lido',
        user: req.user
    });
});

app.post('/api/auth/change-password', authenticateToken, async (req, res) => {
    const { currentPassword, newPassword } = req.body;

    if (!currentPassword || !newPassword) {
        return res.status(400).json({
            error: 'Contrase√±a actual y nueva contrase√±a son requeridas'
        });
    }

    if (newPassword.length < 6) {
        return res.status(400).json({
            error: 'La nueva contrase√±a debe tener al menos 6 caracteres'
        });
    }

    try {
        await AuthService.changePassword(req.user.id, currentPassword, newPassword);
        
        console.log(`üîê Contrase√±a cambiada para usuario: ${req.user.username}`);
        
        res.json({
            message: 'Contrase√±a actualizada exitosamente'
        });

    } catch (error) {
        res.status(400).json({
            error: error.message,
            code: error.code || 'PASSWORD_CHANGE_FAILED'
        });
    }
});

// ===================================================================
// RUTAS PRINCIPALES - CLIENTES
// ===================================================================

app.get('/api/clients', (req, res) => {
    db.all(`
        SELECT c.*, COUNT(l.id) as location_count
        FROM Clients c
        LEFT JOIN Locations l ON c.id = l.client_id
        GROUP BY c.id
        ORDER BY c.name
    `, (err, rows) => {
        if (err) {
            res.status(500).json({ error: err.message });
            return;
        }
        res.json({ message: "success", data: rows });
    });
});

app.get("/api/clients/:id", (req, res) => {
    const sql = "select * from Clients where id = ?"
    const params = [req.params.id]
    db.get(sql, params, (err, row) => {
        if (err) {
          res.status(400).json({"error":err.message});
          return;
        }
        res.json(row);
      });
});

app.post('/api/clients', (req, res) => {
    const { name, legal_name, rut, address, phone, email, business_activity, contact_name } = req.body;
    
    const validation = validateClient(req.body);
    if (!validation.isValid) {
        res.status(400).json({
            "error": "Datos de cliente inv√°lidos",
            "details": validation.errors
        });
        return;
    }
    const sql = 'INSERT INTO Clients (name, legal_name, rut, address, phone, email, business_activity, contact_name) VALUES (?,?,?,?,?,?,?,?)';
    const params = [name, legal_name, rut, address, phone, email, business_activity, contact_name];
    db.run(sql, params, function(err) {
        if (err) {
            if (err.message.includes('UNIQUE constraint failed: Clients.rut')) {
                return res.status(409).json({ "error": "El RUT ingresado ya se encuentra registrado en el sistema." });
            }
            return res.status(400).json({"error":err.message});
        }
        res.status(201).json({ id: this.lastID, ...req.body });
    });
});

app.put("/api/clients/:id", (req, res) => {
    const { name, legal_name, rut, address, phone, email, business_activity, contact_name } = req.body;
    
    const validation = validateClientUpdate(req.body);
    if (!validation.isValid) {
        res.status(400).json({
            "error": "Datos de cliente inv√°lidos",
            "details": validation.errors
        });
        return;
    }
    const sql = `UPDATE Clients set 
                 name = COALESCE(?,name),
                 legal_name = COALESCE(?,legal_name),
                 rut = COALESCE(?,rut),
                 address = COALESCE(?,address),
                 phone = COALESCE(?,phone),
                 email = COALESCE(?,email),
                 business_activity = COALESCE(?,business_activity),
                 contact_name = COALESCE(?,contact_name)
                 WHERE id = ?`;
    const params = [name, legal_name, rut, address, phone, email, business_activity, contact_name, req.params.id];
    db.run(sql, params, function (err, result) {
            if (err){
                res.status(400).json({"error": err.message})
                return;
            }
            res.json({
                message: "success",
                data: req.body,
                changes: this.changes
            })
    });
});

app.delete("/api/clients/:id", (req, res) => {
    const clientId = req.params.id;
    console.log(`üóëÔ∏è Iniciando eliminaci√≥n en cascada para cliente ID: ${clientId}`);
    
    db.serialize(() => {
        db.run("BEGIN TRANSACTION", (err) => {
            if (err) {
                console.error("‚ùå Error al iniciar transacci√≥n:", err);
                return res.status(500).json({"error": "Error al iniciar transacci√≥n: " + err.message});
            }
            
            console.log("üìã Paso 1: Eliminando fotos de equipos...");
            const deleteEquipmentPhotosSQL = `
                DELETE FROM EquipmentPhotos 
                WHERE equipment_id IN (
                    SELECT e.id FROM Equipment e 
                    JOIN Locations l ON e.location_id = l.id 
                    WHERE l.client_id = ?
                )
            `;
            
            db.run(deleteEquipmentPhotosSQL, [clientId], function(err) {
                if (err) {
                    console.error("‚ùå Error eliminando fotos de equipos:", err);
                    return db.run("ROLLBACK", () => {
                        res.status(500).json({"error": "Error eliminando fotos de equipos: " + err.message});
                    });
                }
                console.log(`‚úÖ Eliminadas ${this.changes} fotos de equipos`);
                
                console.log("üé´ Paso 2: Eliminando tickets...");
                const deleteTicketsSQL = `
                    DELETE FROM Tickets 
                    WHERE equipment_id IN (
                        SELECT e.id FROM Equipment e 
                        JOIN Locations l ON e.location_id = l.id 
                        WHERE l.client_id = ?
                    )
                `;
                
                db.run(deleteTicketsSQL, [clientId], function(err) {
                    if (err) {
                        console.error("‚ùå Error eliminando tickets:", err);
                        return db.run("ROLLBACK", () => {
                            res.status(500).json({"error": "Error eliminando tickets: " + err.message});
                        });
                    }
                    console.log(`‚úÖ Eliminados ${this.changes} tickets`);
                    
                    console.log("üîß Paso 3: Eliminando equipos...");
                    const deleteEquipmentSQL = `
                        DELETE FROM Equipment 
                        WHERE location_id IN (
                            SELECT id FROM Locations WHERE client_id = ?
                        )
                    `;
                    
                    db.run(deleteEquipmentSQL, [clientId], function(err) {
                        if (err) {
                            console.error("‚ùå Error eliminando equipos:", err);
                            return db.run("ROLLBACK", () => {
                                res.status(500).json({"error": "Error eliminando equipos: " + err.message});
                            });
                        }
                        console.log(`‚úÖ Eliminados ${this.changes} equipos`);
                        
                        console.log("üè¢ Paso 4: Eliminando sedes...");
                        const deleteLocationsSQL = 'DELETE FROM Locations WHERE client_id = ?';
                        
                        db.run(deleteLocationsSQL, [clientId], function(err) {
                            if (err) {
                                console.error("‚ùå Error eliminando sedes:", err);
                                return db.run("ROLLBACK", () => {
                                    res.status(500).json({"error": "Error eliminando sedes: " + err.message});
                                });
                            }
                            console.log(`‚úÖ Eliminadas ${this.changes} sedes`);
                            
                            console.log("üë§ Paso 5: Eliminando cliente...");
                            const deleteClientSQL = 'DELETE FROM Clients WHERE id = ?';
                            
                            db.run(deleteClientSQL, [clientId], function(err) {
                                if (err) {
                                    console.error("‚ùå Error eliminando cliente:", err);
                                    return db.run("ROLLBACK", () => {
                                        res.status(500).json({"error": "Error eliminando cliente: " + err.message});
                                    });
                                }
                                
                                if (this.changes === 0) {
                                    console.log("‚ö†Ô∏è Cliente no encontrado");
                                    return db.run("ROLLBACK", () => {
                                        res.status(404).json({"error": "Cliente no encontrado"});
                                    });
                                }
                                
                                console.log("‚úÖ Cliente eliminado exitosamente");
                                db.run("COMMIT", (err) => {
                                    if (err) {
                                        console.error("‚ùå Error al confirmar transacci√≥n:", err);
                                        return res.status(500).json({"error": "Error al confirmar eliminaci√≥n: " + err.message});
                                    }
                                    
                                    console.log("üéâ Eliminaci√≥n en cascada completada exitosamente");
                                    res.json({
                                        "message": "Cliente y todos sus datos relacionados eliminados exitosamente",
                                        "clientId": clientId,
                                        "changes": this.changes
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});

// ===================================================================
// RUTAS PRINCIPALES - SEDES/UBICACIONES
// ===================================================================

app.get('/api/locations', (req, res) => {
    const { client_id } = req.query;
    
    let sql = `
        SELECT 
            l.*,
            c.name as client_name,
            COUNT(e.id) as equipment_count
        FROM Locations l
        LEFT JOIN Clients c ON l.client_id = c.id
        LEFT JOIN Equipment e ON l.id = e.location_id
    `;
    
    let params = [];
    
    if (client_id) {
        sql += ` WHERE l.client_id = ?`;
        params.push(client_id);
    }
    
    sql += ` GROUP BY l.id, l.name, l.address, l.client_id, c.name
             ORDER BY c.name, l.name`;
    
    db.all(sql, params, (err, rows) => {
        if (err) {
            res.status(500).json({ error: err.message });
            return;
        }
        res.json({ 
            message: "success",
            data: rows 
        });
    });
});

app.get('/api/clients/:clientId/locations', (req, res) => {
    const { clientId } = req.params;
    
    db.all(`
        SELECT 
            l.id,
            l.name,
            l.address,
            l.client_id,
            l.created_at,
            l.updated_at,
            COUNT(e.id) as equipment_count
        FROM Locations l
        LEFT JOIN Equipment e ON l.id = e.location_id
        WHERE l.client_id = ?
        GROUP BY l.id, l.name, l.address, l.client_id, l.created_at, l.updated_at
        ORDER BY l.name
    `, [clientId], (err, rows) => {
        if (err) {
            console.error('‚ùå Error en consulta de ubicaciones:', err.message);
            res.status(500).json({ error: err.message });
            return;
        }
        res.json({ message: "success", data: rows });
    });
});

app.get("/api/locations/:id", (req, res) => {
    const sql = "SELECT * FROM Locations WHERE id = ?"
    const params = [req.params.id]
    db.get(sql, params, (err, row) => {
        if (err) {
          res.status(400).json({"error":err.message});
          return;
        }
        res.json(row);
      });
});

app.post('/api/locations', (req, res) => {
    const { name, address, client_id } = req.body;
    
    const validation = validateLocation(req.body);
    if (!validation.isValid) {
        res.status(400).json({
            "error": "Datos de ubicaci√≥n inv√°lidos",
            "details": validation.errors
        });
        return;
    }
    const sql = 'INSERT INTO Locations (name, address, client_id) VALUES (?,?,?)';
    const params = [name, address, client_id];
    db.run(sql, params, function(err) {
        if (err) {
            res.status(400).json({"error":err.message});
            return;
        }
        res.status(201).json({ id: this.lastID, ...req.body });
    });
});

app.put("/api/locations/:id", (req, res) => {
    const { name, address } = req.body;
    
    const validation = validateLocationUpdate(req.body);
    if (!validation.isValid) {
        res.status(400).json({
            "error": "Datos de ubicaci√≥n inv√°lidos",
            "details": validation.errors
        });
        return;
    }
    const sql = `UPDATE Locations set 
                 name = COALESCE(?,name), 
                 address = COALESCE(?,address)
                 WHERE id = ?`;
    const params = [name, address, req.params.id];
    db.run(sql, params, function (err, result) {
            if (err){
                res.status(400).json({"error": err.message})
                return;
            }
            res.json({
                message: "success",
                data: req.body,
                changes: this.changes
            })
    });
});

app.delete("/api/locations/:id", (req, res) => {
    const sql = 'DELETE FROM Locations WHERE id = ?';
    const params = [req.params.id];
    db.run(sql, params, function (err, result) {
        if (err){
            res.status(400).json({"error": err.message})
            return;
        }
        res.json({"message":"deleted", changes: this.changes})
    });
});

// ===================================================================
// IMPORTAR M√ìDULOS DE FASES AVANZADAS
// ===================================================================

// FASE 1 ENHANCEMENTS - Sistema de Contratos y Workflow
try {
    const contractsSlaRoutes = require('./routes/contracts-sla');
    const checklistRoutes = require('./routes/checklist');
    const workflowRoutes = require('./routes/workflow');
    
    app.use('/api', contractsSlaRoutes);
    app.use('/api', checklistRoutes);
    app.use('/api', workflowRoutes);
    
    console.log('‚úÖ Fase 1 Routes loaded: Contratos SLA, Checklist, Workflow');
} catch (error) {
    console.warn('‚ö†Ô∏è  Warning: Some Fase 1 routes could not be loaded:', error.message);
}

// FASE 2 ENHANCEMENTS - Sistema de Notificaciones Inteligentes
try {
    const notificationsRoutes = require('./routes/notifications');
    
    app.use('/api/notifications', notificationsRoutes);
    
    console.log('‚úÖ Fase 2 Routes loaded: Sistema de Notificaciones Inteligentes');
} catch (error) {
    console.warn('‚ö†Ô∏è  Warning: Some Fase 2 routes could not be loaded:', error.message);
}

// FASE 3 ENHANCEMENTS - Sistema de Inventario Inteligente y Reportes
try {
    const inventoryRoutes = require('./routes/inventory');
    
    app.use('/api/inventory', inventoryRoutes);
    
    console.log('‚úÖ Fase 3 Routes loaded: Sistema de Inventario Inteligente y Reportes');
} catch (error) {
    console.warn('‚ö†Ô∏è  Warning: Some Fase 3 routes could not be loaded:', error.message);
}

// ===================================================================
// FUNCIONES UTILITARIAS
// ===================================================================

function logTicketChange(ticketId, fieldChanged, oldValue, newValue, changedBy = 'Sistema') {
    const sql = `INSERT INTO TicketHistory 
                 (ticket_id, field_changed, old_value, new_value, changed_by) 
                 VALUES (?, ?, ?, ?, ?)`;
    const params = [ticketId, fieldChanged, oldValue, newValue, changedBy];
    
    db.run(sql, params, function(err) {
        if (err) {
            console.error('‚ö†Ô∏è Error logging ticket change:', err.message);
        } else {
            console.log(`üìù Cambio registrado en ticket ${ticketId}: ${fieldChanged}`);
        }
    });
}

async function createChecklistFromTemplate(ticketId, equipmentId) {
    return new Promise((resolve, reject) => {
        const equipmentSql = `
            SELECT e.type, em.category 
            FROM Equipment e 
            LEFT JOIN EquipmentModels em ON e.model_id = em.id 
            WHERE e.id = ?
        `;
        
        db.get(equipmentSql, [equipmentId], (err, equipment) => {
            if (err) {
                reject(err);
                return;
            }
            
            if (!equipment) {
                resolve([]);
                return;
            }
            
            const templates = {
                'Cardiovascular': [
                    'Verificar funcionamiento de pantalla',
                    'Revisar calibraci√≥n de velocidad',
                    'Inspeccionar correa de transmisi√≥n',
                    'Verificar sistema de inclinaci√≥n',
                    'Probar botones de emergencia',
                    'Limpiar y lubricar componentes m√≥viles'
                ],
                'Fuerza': [
                    'Verificar cables y poleas',
                    'Inspeccionar pesos y contrapesos',
                    'Revisar sistema de seguridad',
                    'Lubricar articulaciones',
                    'Verificar ajustes de asiento',
                    'Probar funcionamiento suave'
                ],
                'Funcional': [
                    'Inspeccionar estructura general',
                    'Verificar estabilidad',
                    'Revisar superficie antideslizante',
                    'Inspeccionar conectores',
                    'Verificar sistema de agarre'
                ],
                'default': [
                    'Inspecci√≥n visual general',
                    'Verificar funcionamiento b√°sico',
                    'Revisar seguridad del equipo',
                    'Limpiar equipo',
                    'Documentar hallazgos'
                ]
            };
            
            const category = equipment.category || equipment.type || 'default';
            const tasks = templates[category] || templates['default'];
            
            let insertedTasks = [];
            let completed = 0;
            
            if (tasks.length === 0) {
                resolve([]);
                return;
            }
            
            tasks.forEach((task, index) => {
                const sql = `INSERT INTO TicketChecklists (ticket_id, title, order_index) VALUES (?, ?, ?)`;
                db.run(sql, [ticketId, task, index], function(err) {
                    if (err) {
                        console.error('Error insertando tarea de checklist:', err);
                    } else {
                        insertedTasks.push({
                            id: this.lastID,
                            ticket_id: ticketId,
                            title: task,
                            order_index: index,
                            is_completed: false,
                            created_at: new Date().toISOString()
                        });
                    }
                    
                    completed++;
                    if (completed === tasks.length) {
                        resolve(insertedTasks);
                    }
                });
            });
        });
    });
}

// ===================================================================
// MANEJADORES GLOBALES DE ERRORES Y FINALIZACI√ìN
// ===================================================================

app.use('*', (req, res) => {
    res.status(404).json({
        error: 'Endpoint no encontrado',
        path: req.originalUrl,
        method: req.method,
        timestamp: new Date().toISOString()
    });
});

app.use((err, req, res, next) => {
    console.error('üí• Error no manejado:', err);
    
    if (err.name === 'JsonWebTokenError') {
        return res.status(401).json({
            error: 'Token inv√°lido',
            code: 'INVALID_TOKEN'
        });
    }
    
    if (err.name === 'TokenExpiredError') {
        return res.status(401).json({
            error: 'Token expirado',
            code: 'TOKEN_EXPIRED'
        });
    }
    
    if (err.type === 'validation') {
        return res.status(400).json({
            error: 'Error de validaci√≥n',
            details: err.details
        });
    }
    
    res.status(500).json({
        error: 'Error interno del servidor',
        message: process.env.NODE_ENV === 'development' ? err.message : 'Error interno',
        timestamp: new Date().toISOString()
    });
});

// ===================================================================
// INICIALIZACI√ìN DEL SERVIDOR
// ===================================================================

function startServer() {
    app.listen(PORT, '0.0.0.0', (err) => {
        if (err) {
            console.error('üí• Error iniciando servidor:', err);
            process.exit(1);
        }
        
        console.log('\nüöÄ ========================================');
        console.log('üöÄ GYMTEC ERP - SERVIDOR INICIADO');
        console.log('üöÄ ========================================');
        console.log(`üåç Servidor corriendo en: http://localhost:${PORT}`);
        console.log(`üåç Accessible via: http://0.0.0.0:${PORT}`);
        console.log(`üîß Modo: ${process.env.NODE_ENV || 'development'}`);
        console.log(`üìÇ Base de datos: ${db.filename || 'MySQL/SQLite'}`);
        console.log('üìã Rutas disponibles:');
        console.log('   üîê /api/auth/* (Autenticaci√≥n)');
        console.log('   üë• /api/clients/* (Gesti√≥n de Clientes)');
        console.log('   üè¢ /api/locations/* (Gesti√≥n de Sedes)');
        console.log('   üîß /api/equipment/* (Gesti√≥n de Equipos)');
        console.log('   üé´ /api/tickets/* (Sistema de Tickets)');
        console.log('   üì¶ /api/inventory/* (Gesti√≥n de Inventario)');
        console.log('   üõí /api/purchase-orders/* (√ìrdenes de Compra)');
        console.log('   üìä /api/dashboard/* (Dashboard y KPIs)');
        console.log('   üë§ /api/users/* (Gesti√≥n de Usuarios)');
        console.log('   üí∞ /api/quotes/* (Cotizaciones)');
        console.log('   üßæ /api/invoices/* (Facturaci√≥n)');
        console.log('   üí∏ /api/expenses/* (Gastos)');
        console.log('   ‚è±Ô∏è  /api/time-entries/* (Control de Tiempo)');
        console.log('   üîî /api/notifications/* (Notificaciones - Fase 2)');
        console.log('   üìà /api/inventory/* (Inventario Inteligente - Fase 3)');
        console.log('üöÄ ========================================\n');
        
        try {
            console.log('üîÑ Inicializando servicios de background...');
            console.log('‚úÖ Servicios de background iniciados correctamente');
        } catch (error) {
            console.warn('‚ö†Ô∏è  Warning: Algunos servicios de background no pudieron iniciarse:', error.message);
        }
    });
}

process.on('SIGINT', () => {
    console.log('\nüõë Recibida se√±al SIGINT, cerrando servidor...');
    db.close((err) => {
        if (err) {
            console.error('‚ùå Error cerrando base de datos:', err.message);
        } else {
            console.log('‚úÖ Base de datos cerrada correctamente');
        }
        process.exit(0);
    });
});

process.on('SIGTERM', () => {
    console.log('\nüõë Recibida se√±al SIGTERM, cerrando servidor...');
    db.close((err) => {
        if (err) {
            console.error('‚ùå Error cerrando base de datos:', err.message);
        } else {
            console.log('‚úÖ Base de datos cerrada correctamente');
        }
        process.exit(0);
    });
});

startServer();
