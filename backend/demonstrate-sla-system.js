// Demostraci√≥n del Sistema de Reglas SLA
const db = require('./src/db-adapter'); // Usar instancia directa
const { initializeSLAProcessor } = require('./src/routes/sla-processor');

async function demonstrateSLASystem() {
    console.log('üéØ Iniciando demostraci√≥n del Sistema de Reglas SLA');
    console.log('=' * 60);
    
    try {
        console.log('‚úÖ Conexi√≥n a base de datos establecida');
        
        // 2. Inicializar el procesador SLA
        const slaProcessor = initializeSLAProcessor(db);
        console.log('‚úÖ Procesador SLA inicializado');
        
        // 3. Crear tareas de prueba con diferentes niveles de violaci√≥n SLA
        console.log('\nüìù Creando tareas de prueba para demostrar violaciones SLA...');
        
        await createTestTasks(db);
        
        // 4. Ejecutar monitoreo SLA
        console.log('\nüîç Ejecutando monitoreo SLA...');
        
        const monitoringResult = await slaProcessor.monitorActiveTasks();
        
        console.log('\nüìä Resultados del monitoreo:');
        console.log(`  ‚Ä¢ Tareas monitoreadas: ${monitoringResult.tasksMonitored}`);
        console.log(`  ‚Ä¢ Violaciones detectadas: ${monitoringResult.violations}`);
        
        if (monitoringResult.details.length > 0) {
            console.log('\n‚ö†Ô∏è  Detalles de violaciones detectadas:');
            monitoringResult.details.forEach((violation, index) => {
                console.log(`\n  ${index + 1}. ${violation.ruleName}`);
                console.log(`     ‚Ä¢ Tarea ID: ${violation.taskId}`);
                console.log(`     ‚Ä¢ Severidad: ${violation.severity}`);
                console.log(`     ‚Ä¢ Prioridad: ${violation.task.priority}`);
                console.log(`     ‚Ä¢ Estado: ${violation.task.status}`);
                console.log(`     ‚Ä¢ Edad: ${violation.task.age_minutes} minutos`);
                if (violation.task.is_overdue) {
                    console.log(`     ‚Ä¢ ‚ö†Ô∏è  VENCIDA`);
                }
            });
        }
        
        // 5. Mostrar estad√≠sticas SLA
        console.log('\nüìà Obteniendo estad√≠sticas SLA...');
        
        const stats = await slaProcessor.getSLAStatistics();
        
        console.log('\nüìä Estad√≠sticas SLA (√∫ltimos 30 d√≠as):');
        if (stats.length > 0) {
            stats.forEach(stat => {
                console.log(`  ‚Ä¢ ${stat.violation_date}: ${stat.total_violations} violaciones`);
                console.log(`    - Cr√≠ticas: ${stat.critical_violations}`);
                console.log(`    - Altas: ${stat.high_violations}`);
                console.log(`    - Medias: ${stat.medium_violations}`);
                console.log(`    - Bajas: ${stat.low_violations}`);
            });
        } else {
            console.log('  No hay estad√≠sticas disponibles a√∫n');
        }
        
        // 6. Mostrar reglas SLA activas
        console.log('\nüìã Reglas SLA activas:');
        
        const rules = Array.from(slaProcessor.rules.values());
        rules.forEach((rule, index) => {
            console.log(`\n  ${index + 1}. ${rule.name}`);
            console.log(`     ‚Ä¢ Estado: ${rule.enabled ? '‚úÖ Activa' : '‚ùå Inactiva'}`);
            console.log(`     ‚Ä¢ Condiciones: ${JSON.stringify(rule.conditions)}`);
            console.log(`     ‚Ä¢ Acciones: ${rule.actions.map(a => a.type).join(', ')}`);
        });
        
        // 7. Verificar violaciones registradas en la base de datos
        console.log('\nüìù Verificando violaciones registradas en la base de datos...');
        
        const violationsSql = `
            SELECT 
                sv.*,
                mt.title,
                mt.priority,
                mt.status
            FROM sla_violations sv
            JOIN maintenancetasks mt ON sv.task_id = mt.id
            ORDER BY sv.created_at DESC
            LIMIT 10
        `;
        
        await new Promise((resolve, reject) => {
            db.all(violationsSql, [], (err, violations) => {
                if (err) {
                    console.error('‚ùå Error obteniendo violaciones:', err);
                    reject(err);
                    return;
                }
                
                if (violations.length > 0) {
                    console.log(`\nüìä √öltimas ${violations.length} violaciones registradas:`);
                    violations.forEach((violation, index) => {
                        console.log(`\n  ${index + 1}. ${violation.rule_name}`);
                        console.log(`     ‚Ä¢ Tarea: ${violation.title || 'Sin t√≠tulo'}`);
                        console.log(`     ‚Ä¢ Severidad: ${violation.severity}`);
                        console.log(`     ‚Ä¢ Fecha: ${violation.created_at}`);
                        console.log(`     ‚Ä¢ Resuelto: ${violation.resolved ? '‚úÖ' : '‚ùå'}`);
                    });
                } else {
                    console.log('  No hay violaciones registradas');
                }
                
                resolve();
            });
        });
        
        // 8. Verificar acciones ejecutadas
        console.log('\nüîß Verificando acciones SLA ejecutadas...');
        
        const actionsSql = `
            SELECT 
                sal.*,
                mt.title
            FROM sla_action_log sal
            JOIN maintenancetasks mt ON sal.task_id = mt.id
            ORDER BY sal.executed_at DESC
            LIMIT 10
        `;
        
        await new Promise((resolve, reject) => {
            db.all(actionsSql, [], (err, actions) => {
                if (err) {
                    console.error('‚ùå Error obteniendo acciones:', err);
                    reject(err);
                    return;
                }
                
                if (actions.length > 0) {
                    console.log(`\nüìä √öltimas ${actions.length} acciones ejecutadas:`);
                    actions.forEach((action, index) => {
                        console.log(`\n  ${index + 1}. ${action.action_type.toUpperCase()}`);
                        console.log(`     ‚Ä¢ Tarea: ${action.title || 'Sin t√≠tulo'}`);
                        console.log(`     ‚Ä¢ Mensaje: ${action.message || 'N/A'}`);
                        console.log(`     ‚Ä¢ Ejecutado: ${action.executed_at}`);
                        console.log(`     ‚Ä¢ Por: ${action.executed_by}`);
                    });
                } else {
                    console.log('  No hay acciones registradas');
                }
                
                resolve();
            });
        });
        
        // 9. Simular escalaci√≥n de una tarea cr√≠tica
        console.log('\nüö® Simulando escalaci√≥n de tarea cr√≠tica...');
        
        const criticalTaskSql = `
            SELECT * FROM maintenancetasks 
            WHERE priority = 'critical' AND status IN ('pending', 'scheduled')
            LIMIT 1
        `;
        
        await new Promise((resolve, reject) => {
            db.get(criticalTaskSql, [], async (err, task) => {
                if (err) {
                    reject(err);
                    return;
                }
                
                if (task) {
                    console.log(`\nüéØ Escalando tarea cr√≠tica: ${task.title || `ID ${task.id}`}`);
                    
                    // Simular escalaci√≥n
                    const escalationSql = `
                        UPDATE maintenancetasks 
                        SET escalated_to = 1, escalated_at = NOW(), priority = 'critical'
                        WHERE id = ?
                    `;
                    
                    db.run(escalationSql, [task.id], function(escalateErr) {
                        if (escalateErr) {
                            console.error('‚ùå Error escalando tarea:', escalateErr);
                        } else {
                            console.log('‚úÖ Tarea escalada exitosamente');
                        }
                        resolve();
                    });
                } else {
                    console.log('  No hay tareas cr√≠ticas para escalar');
                    resolve();
                }
            });
        });
        
        console.log('\nüéâ Demostraci√≥n del Sistema SLA completada exitosamente');
        console.log('\nüìã Resumen de capacidades demostradas:');
        console.log('  ‚úÖ Monitoreo autom√°tico de tareas activas');
        console.log('  ‚úÖ Detecci√≥n de violaciones SLA basada en reglas');
        console.log('  ‚úÖ Escalaci√≥n autom√°tica de tareas cr√≠ticas');
        console.log('  ‚úÖ Registro de violaciones y acciones');
        console.log('  ‚úÖ Generaci√≥n de estad√≠sticas y m√©tricas');
        console.log('  ‚úÖ Sistema de reglas configurable');
        console.log('  ‚úÖ Log de auditor√≠a completo');
        
    } catch (error) {
        console.error('‚ùå Error en demostraci√≥n SLA:', error);
        throw error;
    }
}

async function createTestTasks(db) {
    console.log('üìù Creando tareas de prueba con diferentes violaciones SLA...');
    
    const testTasks = [
        {
            title: 'Mantenimiento Cr√≠tico - Falla Sistema Cardio',
            description: 'Falla cr√≠tica en sistema cardiovascular principal',
            priority: 'critical',
            status: 'pending',
            location_id: 1,
            created_minutes_ago: 45 // Viola regla de 30 minutos
        },
        {
            title: 'Reparaci√≥n Urgente - M√°quina Pesas',
            description: 'Reparaci√≥n urgente en m√°quina de pesas',
            priority: 'high',
            status: 'scheduled',
            location_id: 1,
            created_minutes_ago: 300 // Viola regla de 4 horas (240 min)
        },
        {
            title: 'Mantenimiento Preventivo',
            description: 'Mantenimiento preventivo rutinario',
            priority: 'medium',
            status: 'pending',
            location_id: 1,
            created_minutes_ago: 1500 // Viola regla de 24 horas (1440 min)
        },
        {
            title: 'Tarea Vencida - Limpieza Profunda',
            description: 'Limpieza profunda de equipos',
            priority: 'low',
            status: 'in_progress',
            location_id: 1,
            created_minutes_ago: 2000, // Muy vencida
            sla_deadline_hours_ago: 24 // SLA vencido hace 24 horas
        }
    ];
    
    for (const task of testTasks) {
        const sql = `
            INSERT INTO maintenancetasks 
            (title, description, priority, status, location_id, equipment_id, created_at, sla_deadline)
            VALUES (?, ?, ?, ?, ?, 1, 
                    DATE_SUB(NOW(), INTERVAL ? MINUTE),
                    DATE_SUB(NOW(), INTERVAL ? HOUR))
        `;
        
        const slaDeadlineHours = task.sla_deadline_hours_ago || 
            (task.priority === 'critical' ? -0.5 : 
             task.priority === 'high' ? -4 : 
             task.priority === 'medium' ? -24 : -48);
        
        await new Promise((resolve, reject) => {
            db.run(sql, [
                task.title,
                task.description,
                task.priority,
                task.status,
                task.location_id,
                task.created_minutes_ago,
                Math.abs(slaDeadlineHours)
            ], function(err) {
                if (err) {
                    console.error(`‚ùå Error creando tarea "${task.title}":`, err);
                    reject(err);
                } else {
                    console.log(`‚úÖ Tarea creada: "${task.title}" (ID: ${this.lastID})`);
                    resolve(this.lastID);
                }
            });
        });
    }
}

// Ejecutar demostraci√≥n si se llama directamente
if (require.main === module) {
    demonstrateSLASystem()
        .then(() => {
            console.log('\nüèÅ Demostraci√≥n completada');
            process.exit(0);
        })
        .catch(error => {
            console.error('üí• Error en demostraci√≥n:', error);
            process.exit(1);
        });
}

module.exports = { demonstrateSLASystem };