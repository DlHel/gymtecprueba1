<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Autenticaci√≥n - Gymtec</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug de Autenticaci√≥n - Gymtec ERP</h1>
    
    <div class="section">
        <h3>1. Verificaci√≥n de Scripts</h3>
        <div id="scripts-check"></div>
    </div>
    
    <div class="section">
        <h3>2. Estado de Autenticaci√≥n</h3>
        <div id="auth-status"></div>
    </div>
    
    <div class="section">
        <h3>3. Test de API</h3>
        <div id="api-test"></div>
        <button onclick="testAPI()">üß™ Probar API de Tickets</button>
    </div>
    
    <div class="section">
        <h3>4. Crear Ticket de Prueba</h3>
        <div id="create-ticket"></div>
        <button onclick="createTestTicket()">üé´ Crear Ticket de Prueba</button>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        function log(selector, message, type = 'info') {
            const element = document.querySelector(selector);
            const className = type;
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }
        
        function logPre(selector, data) {
            const element = document.querySelector(selector);
            element.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        // 1. Verificar scripts
        function checkScripts() {
            log('#scripts-check', 'üîç Verificando scripts cargados...');
            
            if (typeof API_URL !== 'undefined') {
                log('#scripts-check', `‚úÖ config.js cargado - API_URL: ${API_URL}`, 'success');
            } else {
                log('#scripts-check', '‚ùå config.js NO cargado', 'error');
            }
            
            if (typeof AuthManager !== 'undefined') {
                log('#scripts-check', '‚úÖ AuthManager (clase) disponible', 'success');
            } else {
                log('#scripts-check', '‚ùå AuthManager (clase) NO disponible', 'error');
            }
            
            if (typeof window.authManager !== 'undefined') {
                log('#scripts-check', '‚úÖ window.authManager (instancia) disponible', 'success');
            } else {
                log('#scripts-check', '‚ùå window.authManager (instancia) NO disponible', 'error');
            }
            
            if (typeof window.AuthManager !== 'undefined') {
                log('#scripts-check', '‚úÖ window.AuthManager (alias) disponible', 'success');
            } else {
                log('#scripts-check', '‚ùå window.AuthManager (alias) NO disponible', 'error');
            }
            
            if (typeof authenticatedFetch !== 'undefined') {
                log('#scripts-check', '‚úÖ authenticatedFetch funci√≥n global disponible', 'success');
            } else {
                log('#scripts-check', '‚ùå authenticatedFetch funci√≥n global NO disponible', 'error');
            }
        }
        
        // 2. Verificar autenticaci√≥n
        function checkAuth() {
            log('#auth-status', 'üîç Verificando estado de autenticaci√≥n...');
            
            try {
                const token = localStorage.getItem('gymtec_token');
                if (token) {
                    log('#auth-status', '‚úÖ Token encontrado en localStorage', 'success');
                    log('#auth-status', `üìù Token: ${token.substring(0, 50)}...`, 'info');
                } else {
                    log('#auth-status', '‚ùå NO hay token en localStorage', 'error');
                }
                
                const user = localStorage.getItem('gymtec_user');
                if (user) {
                    log('#auth-status', '‚úÖ Datos de usuario encontrados', 'success');
                    logPre('#auth-status', JSON.parse(user));
                } else {
                    log('#auth-status', '‚ùå NO hay datos de usuario', 'error');
                }
                
                if (window.authManager) {
                    const isAuth = window.authManager.isAuthenticated();
                    if (isAuth) {
                        log('#auth-status', '‚úÖ AuthManager dice: Usuario autenticado', 'success');
                    } else {
                        log('#auth-status', '‚ùå AuthManager dice: Usuario NO autenticado', 'error');
                    }
                } else {
                    log('#auth-status', '‚ùå AuthManager no disponible', 'error');
                }
            } catch (error) {
                log('#auth-status', `‚ùå Error verificando autenticaci√≥n: ${error.message}`, 'error');
            }
        }
        
        // 3. Test API
        async function testAPI() {
            log('#api-test', 'üîç Probando API de tickets...');
            
            try {
                if (!window.authenticatedFetch) {
                    log('#api-test', '‚ùå authenticatedFetch no disponible', 'error');
                    return;
                }
                
                const response = await authenticatedFetch(`${API_URL}/tickets`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('#api-test', `‚úÖ API responde correctamente: ${data.data.length} tickets`, 'success');
                    logPre('#api-test', data.data.slice(0, 3));
                } else {
                    const errorData = await response.text();
                    log('#api-test', `‚ùå Error API: ${response.status} - ${errorData}`, 'error');
                }
            } catch (error) {
                log('#api-test', `‚ùå Error probando API: ${error.message}`, 'error');
            }
        }
        
        // 4. Crear ticket
        async function createTestTicket() {
            log('#create-ticket', 'üé´ Creando ticket de prueba...');
            
            try {
                const ticketData = {
                    title: `Ticket Debug ${new Date().getTime()}`,
                    description: 'Ticket creado desde debug para probar la funcionalidad',
                    priority: 'Media',
                    equipment_id: 1,
                    location_id: 1,
                    client_id: 1,
                    assigned_to: 1
                };
                
                const response = await authenticatedFetch(`${API_URL}/tickets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('#create-ticket', `‚úÖ Ticket creado exitosamente con ID: ${data.data.id}`, 'success');
                    logPre('#create-ticket', data.data);
                } else {
                    const errorData = await response.text();
                    log('#create-ticket', `‚ùå Error creando ticket: ${response.status} - ${errorData}`, 'error');
                }
            } catch (error) {
                log('#create-ticket', `‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Ejecutar verificaciones al cargar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkScripts();
                checkAuth();
            }, 100);
        });
    </script>
</body>
</html>