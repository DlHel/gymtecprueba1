<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Login - Diagnóstico</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #00ff00;
            border-radius: 5px;
            background: #000;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        .error {
            color: #ff0000;
            border-color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
    </style>
</head>
<body>
    <h1>🔍 Diagnóstico de Login - GYMTEC</h1>
    
    <div id="results"></div>
    
    <button onclick="testLogin()">🧪 Probar Login</button>
    <button onclick="clearResults()">🗑️ Limpiar</button>

    <script src="js/config.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');

        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testLogin() {
            clearResults();
            
            log('🚀 Iniciando test de login...');
            
            // 1. Verificar configuración
            log(`📍 API_URL configurada: ${window.API_URL || 'NO DISPONIBLE'}`, !window.API_URL);
            
            const apiUrl = window.API_URL || 'http://localhost:3000/api';
            const endpoint = `${apiUrl}/auth/login`;
            
            log(`🎯 Endpoint completo: ${endpoint}`);
            
            // 2. Preparar datos
            const credentials = {
                username: 'admin',
                password: 'admin123'
            };
            
            log(`📦 Enviando credenciales: ${JSON.stringify(credentials)}`);
            
            // 3. Hacer la petición
            try {
                log('📡 Enviando petición HTTP POST...');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(credentials)
                });
                
                log(`📊 Status Code: ${response.status}`);
                log(`📋 Status Text: ${response.statusText}`);
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`✅ LOGIN EXITOSO!`);
                    log(`👤 Usuario: ${data.user.username}`);
                    log(`📧 Email: ${data.user.email}`);
                    log(`👔 Role: ${data.user.role}`);
                    log(`🔑 Token recibido: ${data.token.substring(0, 50)}...`);
                    
                    // Guardar en localStorage
                    localStorage.setItem('gymtec_token', data.token);
                    localStorage.setItem('gymtec_user', JSON.stringify(data.user));
                    
                    log(`💾 Token guardado en localStorage`);
                    log(`🎉 ¡Puedes ir al dashboard ahora!`);
                } else {
                    log(`❌ LOGIN FALLÓ!`, true);
                    log(`Error: ${data.error || 'Desconocido'}`, true);
                    log(`Code: ${data.code || 'N/A'}`, true);
                    log(`Respuesta completa: ${JSON.stringify(data, null, 2)}`, true);
                }
                
            } catch (error) {
                log(`❌ ERROR EN LA PETICIÓN`, true);
                log(`Mensaje: ${error.message}`, true);
                log(`Stack: ${error.stack}`, true);
                
                log(`💡 Posibles causas:`, true);
                log(`1. El servidor backend no está corriendo`, true);
                log(`2. Problema de CORS`, true);
                log(`3. URL incorrecta`, true);
                log(`4. Firewall bloqueando la conexión`, true);
            }
        }

        // Auto-ejecutar al cargar
        window.addEventListener('DOMContentLoaded', () => {
            log('🔧 Página de diagnóstico cargada');
            log('💡 Haz clic en "Probar Login" para comenzar');
        });
    </script>
</body>
</html>
