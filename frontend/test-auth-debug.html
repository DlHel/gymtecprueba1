<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth Debug - Gymtec ERP</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .debug-box { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #2563eb; }
        pre { 
            background: #1f2937; 
            color: #10b981; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
    <h1>🔍 Test de Autenticación - Gymtec ERP</h1>
    
    <div class="debug-box">
        <h2>Estado Actual</h2>
        <div id="status"></div>
    </div>
    
    <div class="debug-box">
        <h2>Controles de Prueba</h2>
        <button onclick="testAuth()">🔍 Test Auth Complete</button>
        <button onclick="testApiEndpoint()">🌐 Test API Endpoint</button>
        <button onclick="simulateLogin()">🔑 Simular Login</button>
        <button onclick="clearStorage()">🗑️ Limpiar Storage</button>
        <button onclick="goToTickets()">🎫 Ir a Tickets</button>
    </div>
    
    <div class="debug-box">
        <h2>Log de Debug</h2>
        <pre id="debug-log"></pre>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        let logContainer = document.getElementById('debug-log');
        let statusContainer = document.getElementById('status');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(message);
        }
        
        function updateStatus() {
            const hasToken = !!localStorage.getItem('gymtec_token');
            const hasUser = !!localStorage.getItem('gymtec_user');
            const authManagerReady = !!window.AuthManager;
            const isAuthenticated = authManagerReady ? AuthManager.isAuthenticated() : false;
            
            let statusHtml = `
                <p><strong>🔑 Token en localStorage:</strong> ${hasToken ? '✅ Sí' : '❌ No'}</p>
                <p><strong>👤 Datos de usuario:</strong> ${hasUser ? '✅ Sí' : '❌ No'}</p>
                <p><strong>🛠️ AuthManager disponible:</strong> ${authManagerReady ? '✅ Sí' : '❌ No'}</p>
                <p><strong>🔐 isAuthenticated():</strong> ${isAuthenticated ? '✅ Sí' : '❌ No'}</p>
            `;
            
            if (hasToken) {
                const token = localStorage.getItem('gymtec_token');
                statusHtml += `<p><strong>Token:</strong> ${token.substring(0, 30)}...</p>`;
            }
            
            if (hasUser) {
                try {
                    const user = JSON.parse(localStorage.getItem('gymtec_user'));
                    statusHtml += `<p><strong>Usuario:</strong> ${user.username} (${user.role})</p>`;
                } catch (e) {
                    statusHtml += `<p><strong>Usuario:</strong> ❌ Error parsing</p>`;
                }
            }
            
            statusContainer.innerHTML = statusHtml;
        }
        
        async function testAuth() {
            log('🔍 Iniciando test completo de autenticación...');
            
            // Test 1: Verificar LocalStorage
            log('📱 Test 1: Verificando localStorage...');
            const token = localStorage.getItem('gymtec_token');
            const user = localStorage.getItem('gymtec_user');
            
            if (!token) {
                log('❌ No hay token en localStorage');
                return;
            }
            log('✅ Token encontrado en localStorage');
            
            if (!user) {
                log('⚠️ No hay datos de usuario en localStorage');
            } else {
                try {
                    const userData = JSON.parse(user);
                    log(`✅ Usuario: ${userData.username} (${userData.role})`);
                } catch (e) {
                    log('❌ Error parsing datos de usuario');
                    return;
                }
            }
            
            // Test 2: Verificar AuthManager
            log('🛠️ Test 2: Verificando AuthManager...');
            if (!window.AuthManager) {
                log('❌ AuthManager no está disponible');
                return;
            }
            log('✅ AuthManager disponible');
            
            // Test 3: Verificar isAuthenticated
            log('🔐 Test 3: Verificando isAuthenticated...');
            const isAuth = AuthManager.isAuthenticated();
            log(`🔐 isAuthenticated(): ${isAuth}`);
            
            // Test 4: Verificar con servidor
            log('🌐 Test 4: Verificando con servidor...');
            try {
                const response = await AuthManager.authenticatedFetch(`${API_URL}/auth/verify`);
                if (response.ok) {
                    const data = await response.json();
                    log('✅ Token válido en servidor');
                    log(`👤 Usuario del servidor: ${data.user.username}`);
                } else {
                    log(`❌ Token inválido en servidor (${response.status})`);
                }
            } catch (error) {
                log(`❌ Error conectando con servidor: ${error.message}`);
            }
            
            updateStatus();
        }
        
        async function testApiEndpoint() {
            log('🌐 Probando endpoint directo...');
            
            const token = localStorage.getItem('gymtec_token');
            if (!token) {
                log('❌ No hay token para probar');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`📡 Respuesta del servidor: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('✅ Respuesta exitosa:');
                    log(JSON.stringify(data, null, 2));
                } else {
                    const errorData = await response.json();
                    log('❌ Error del servidor:');
                    log(JSON.stringify(errorData, null, 2));
                }
            } catch (error) {
                log(`❌ Error de conexión: ${error.message}`);
            }
        }
        
        function simulateLogin() {
            log('🔑 Simulando login con datos de prueba...');
            
            // Token de prueba válido (deberías reemplazar con uno real)
            const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJBZG1pbiIsImlhdCI6MTYzMDAwMDAwMCwiZXhwIjoxNjMwMDg2NDAwfQ.test';
            const testUser = {
                id: 1,
                username: 'admin',
                role: 'Admin'
            };
            
            localStorage.setItem('gymtec_token', testToken);
            localStorage.setItem('gymtec_user', JSON.stringify(testUser));
            
            log('✅ Datos de prueba guardados en localStorage');
            updateStatus();
        }
        
        function clearStorage() {
            log('🗑️ Limpiando localStorage...');
            localStorage.removeItem('gymtec_token');
            localStorage.removeItem('gymtec_user');
            log('✅ localStorage limpiado');
            updateStatus();
        }
        
        function goToTickets() {
            log('🎫 Navegando a tickets...');
            window.location.href = '/tickets.html';
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 Test de autenticación iniciado');
            log(`🌐 API_URL: ${API_URL}`);
            updateStatus();
        });
    </script>
</body>
</html>
