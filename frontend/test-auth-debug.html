<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth Debug - Gymtec ERP</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .debug-box { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #2563eb; }
        pre { 
            background: #1f2937; 
            color: #10b981; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
    <h1>ğŸ” Test de AutenticaciÃ³n - Gymtec ERP</h1>
    
    <div class="debug-box">
        <h2>Estado Actual</h2>
        <div id="status"></div>
    </div>
    
    <div class="debug-box">
        <h2>Controles de Prueba</h2>
        <button onclick="testAuth()">ğŸ” Test Auth Complete</button>
        <button onclick="testApiEndpoint()">ğŸŒ Test API Endpoint</button>
        <button onclick="simulateLogin()">ğŸ”‘ Simular Login</button>
        <button onclick="clearStorage()">ğŸ—‘ï¸ Limpiar Storage</button>
        <button onclick="goToTickets()">ğŸ« Ir a Tickets</button>
    </div>
    
    <div class="debug-box">
        <h2>Log de Debug</h2>
        <pre id="debug-log"></pre>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        let logContainer = document.getElementById('debug-log');
        let statusContainer = document.getElementById('status');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(message);
        }
        
        function updateStatus() {
            const hasToken = !!localStorage.getItem('gymtec_token');
            const hasUser = !!localStorage.getItem('gymtec_user');
            const authManagerReady = !!window.AuthManager;
            const isAuthenticated = authManagerReady ? AuthManager.isAuthenticated() : false;
            
            let statusHtml = `
                <p><strong>ğŸ”‘ Token en localStorage:</strong> ${hasToken ? 'âœ… SÃ­' : 'âŒ No'}</p>
                <p><strong>ğŸ‘¤ Datos de usuario:</strong> ${hasUser ? 'âœ… SÃ­' : 'âŒ No'}</p>
                <p><strong>ğŸ› ï¸ AuthManager disponible:</strong> ${authManagerReady ? 'âœ… SÃ­' : 'âŒ No'}</p>
                <p><strong>ğŸ” isAuthenticated():</strong> ${isAuthenticated ? 'âœ… SÃ­' : 'âŒ No'}</p>
            `;
            
            if (hasToken) {
                const token = localStorage.getItem('gymtec_token');
                statusHtml += `<p><strong>Token:</strong> ${token.substring(0, 30)}...</p>`;
            }
            
            if (hasUser) {
                try {
                    const user = JSON.parse(localStorage.getItem('gymtec_user'));
                    statusHtml += `<p><strong>Usuario:</strong> ${user.username} (${user.role})</p>`;
                } catch (e) {
                    statusHtml += `<p><strong>Usuario:</strong> âŒ Error parsing</p>`;
                }
            }
            
            statusContainer.innerHTML = statusHtml;
        }
        
        async function testAuth() {
            log('ğŸ” Iniciando test completo de autenticaciÃ³n...');
            
            // Test 1: Verificar LocalStorage
            log('ğŸ“± Test 1: Verificando localStorage...');
            const token = localStorage.getItem('gymtec_token');
            const user = localStorage.getItem('gymtec_user');
            
            if (!token) {
                log('âŒ No hay token en localStorage');
                return;
            }
            log('âœ… Token encontrado en localStorage');
            
            if (!user) {
                log('âš ï¸ No hay datos de usuario en localStorage');
            } else {
                try {
                    const userData = JSON.parse(user);
                    log(`âœ… Usuario: ${userData.username} (${userData.role})`);
                } catch (e) {
                    log('âŒ Error parsing datos de usuario');
                    return;
                }
            }
            
            // Test 2: Verificar AuthManager
            log('ğŸ› ï¸ Test 2: Verificando AuthManager...');
            if (!window.AuthManager) {
                log('âŒ AuthManager no estÃ¡ disponible');
                return;
            }
            log('âœ… AuthManager disponible');
            
            // Test 3: Verificar isAuthenticated
            log('ğŸ” Test 3: Verificando isAuthenticated...');
            const isAuth = AuthManager.isAuthenticated();
            log(`ğŸ” isAuthenticated(): ${isAuth}`);
            
            // Test 4: Verificar con servidor
            log('ğŸŒ Test 4: Verificando con servidor...');
            try {
                const response = await AuthManager.authenticatedFetch(`${API_URL}/auth/verify`);
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Token vÃ¡lido en servidor');
                    log(`ğŸ‘¤ Usuario del servidor: ${data.user.username}`);
                } else {
                    log(`âŒ Token invÃ¡lido en servidor (${response.status})`);
                }
            } catch (error) {
                log(`âŒ Error conectando con servidor: ${error.message}`);
            }
            
            updateStatus();
        }
        
        async function testApiEndpoint() {
            log('ğŸŒ Probando endpoint directo...');
            
            const token = localStorage.getItem('gymtec_token');
            if (!token) {
                log('âŒ No hay token para probar');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`ğŸ“¡ Respuesta del servidor: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Respuesta exitosa:');
                    log(JSON.stringify(data, null, 2));
                } else {
                    const errorData = await response.json();
                    log('âŒ Error del servidor:');
                    log(JSON.stringify(errorData, null, 2));
                }
            } catch (error) {
                log(`âŒ Error de conexiÃ³n: ${error.message}`);
            }
        }
        
        function simulateLogin() {
            log('ğŸ”‘ Simulando login con datos de prueba...');
            
            // Token de prueba vÃ¡lido (deberÃ­as reemplazar con uno real)
            const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJBZG1pbiIsImlhdCI6MTYzMDAwMDAwMCwiZXhwIjoxNjMwMDg2NDAwfQ.test';
            const testUser = {
                id: 1,
                username: 'admin',
                role: 'Admin'
            };
            
            localStorage.setItem('gymtec_token', testToken);
            localStorage.setItem('gymtec_user', JSON.stringify(testUser));
            
            log('âœ… Datos de prueba guardados en localStorage');
            updateStatus();
        }
        
        function clearStorage() {
            log('ğŸ—‘ï¸ Limpiando localStorage...');
            localStorage.removeItem('gymtec_token');
            localStorage.removeItem('gymtec_user');
            log('âœ… localStorage limpiado');
            updateStatus();
        }
        
        function goToTickets() {
            log('ğŸ« Navegando a tickets...');
            window.location.href = '/tickets.html';
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Test de autenticaciÃ³n iniciado');
            log(`ğŸŒ API_URL: ${API_URL}`);
            updateStatus();
        });
    </script>
</body>
</html>
